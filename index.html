<html>

    <head>
        <title>A Multiplayer Game</title>
        <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
        <style>
            #gameController { background-color: grey; border: 1px solid black; }
            #gameController #enemyHand { background-color: red; border: 1px solid black; }
            #gameController #playerHand { background-color: blue; border: 1px solid black; }
            #gameController #table { background-color: yellow; border: 1px solid black; }
            #gameController #deck { background-color: green; border: 1px solid black; }

            .card { background-color: brown; border: 1px solid black; width: 40px; height: 90px; display: flex; flex-direction: column; }
        </style>
    </head>

    <body>
        <div id="roomController">
            <input id="room" type="text">
            <button id="join">Join Room</button>
        </div>
        <div id="gameController" style="padding: 20px;">
            <div id="deck" style="width: 99%; height: 100px; padding: 5px; display: flex; flex-direction: row;"></div>
            <div style="height: 20px;"></div>
            <div id="enemyHand" style="width: 99%; height: 100px; padding: 5px; display: flex; flex-direction: row;"></div>
            <div id="table" style="width: 99%; height: 100px; padding: 5px; display: flex; flex-direction: row;"></div>
            <div id="playerHand" style="width: 99%; height: 100px; padding: 5px; display: flex; flex-direction: row;"></div>
        </div>

        <script>
            $(document).ready(function () {
                // var socket = io.connect('https://deck-server.herokuapp.com/');
                let socket = io.connect('http://localhost:5000');
                let enabledToPlay = false;

                $('#join').click(function (event) {
                    let room = $('#room').val();
                    socket.emit('join_room', room);
                });

                socket.on('started_game', function () {
                    console.log('started_game');
                    for(let i = 0; i < 52; i ++) {
                        let divCard = $('<div/>').addClass('card');
                        $('#deck').append(divCard);
                    }

                    let startCards = 0;
                    let drawing = setInterval(function () {
                        if (startCards < 3) {
                            startCards++;
                            socket.emit('draw_card');
                        } else {
                            clearInterval(drawing);
                        }
                    }, 500);
                });

                socket.on('start_player', function () {
                    console.log('Enabled to play');
                    enabledToPlay = true;
                });

                socket.on('drawn_card', function (card) {
                    let spanSuit = $('<span/>').text(card.slice(0, 1));
                    let spanValue = $('<span/>').text(card.slice(1));
                    let divCard = $('<div/>').addClass('card').append(spanValue).append(spanSuit).click(onClickedCard);
                    $('#playerHand').append(divCard);
                });

                socket.on('drawn_enemy_card', function () {
                    let e = $('#deck div:last-child').detach();
                    $('#enemyHand').append(e);
                });

                socket.on('played_enemy_card', function (card) {
                    let spanSuit = $('<span/>').text(card.slice(0, 1));
                    let spanValue = $('<span/>').text(card.slice(1));
                    let divCard = $('<div/>').addClass('card').append(spanValue).append(spanSuit);
                    $('#table').append(divCard);
                    enabledToPlay = true;
                });

                var onClickedCard = function (event) {
                    if (enabledToPlay) {
                        let card = $(event.currentTarget);
                        card.detach();
                        $('#table').append(card);

                        let suit = card.children().last().text();
                        let value = card.children().first().text();
                        socket.emit('play_card', suit + value);

                        enabledToPlay = false;
                    }
                }
            });
        </script>
    </body>

</html>
